name: Deploy to Firebase

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3

      # ===== FLUTTER WEB BUILD =====
      - name: 🔧 Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.24.0'

      - name: 📦 Install Flutter dependencies
        run: flutter pub get

      - name: 🏗️ Build Flutter Web
        run: |
          flutter build web --release \
            --dart-define=PROJECT_ID=${{ secrets.PROJECT_ID }} \
            --dart-define=MESSAGING_SENDER_ID=${{ secrets.MESSAGING_SENDER_ID }} \
            --dart-define=STORAGE_BUCKET=${{ secrets.STORAGE_BUCKET }} \
            --dart-define=WEB_API_KEY=${{ secrets.WEB_API_KEY }} \
            --dart-define=WEB_APP_ID=${{ secrets.WEB_APP_ID }} \
            --dart-define=WEB_AUTH_DOMAIN=${{ secrets.WEB_AUTH_DOMAIN }} \
            --dart-define=WEB_MEASUREMENT_ID=${{ secrets.WEB_MEASUREMENT_ID }}
      
      # ===== FIREBASE FUNCTIONS BUILD =====
      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: 📦 Install Functions dependencies
        working-directory: functions
        run: npm ci

      - name: 🏗️ Build Functions
        working-directory: functions
        run: npm run build

      # ===== FIREBASE DEPLOY =====
      - name: 🔧 Setup Firebase CLI
        run: npm install -g firebase-tools

      - name: 🔑 Configure AWS credentials for Functions
        run: |
          firebase functions:config:set \
            aws.access_key_id="${{ secrets.AWS_ACCESS_KEY_ID }}" \
            aws.secret_access_key="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
            aws.region="${{ secrets.AWS_REGION }}" \
            --project ${{ secrets.FIREBASE_PROJECT_ID }} \
            --token ${{ secrets.FIREBASE_TOKEN }}

      - name: 🚀 Deploy to Firebase
        run: |
          firebase deploy \
            --only functions,hosting \
            --project ${{ secrets.FIREBASE_PROJECT_ID }} \
            --token ${{ secrets.FIREBASE_TOKEN }} \
            --non-interactive

      - name: ✅ Deployment complete
        run: |
          echo "🎉 Deployment successful!"
          echo ""
          echo "🔗 Your app is live at:"
          echo "   https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app"
          echo ""
          echo "⚙️  Functions dashboard:"
          echo "   https://console.firebase.google.com/project/${{ secrets.FIREBASE_PROJECT_ID }}/functions"
name: Deploy to Firebase

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      # ===== FLUTTER WEB BUILD =====
      - name: ğŸ”§ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.24.0'

      - name: ğŸ“¦ Install Flutter dependencies
        run: flutter pub get

      - name: ğŸ“ Create .env file for build
        run: |
          mkdir -p assets
          cat > assets/.env << 'EOF'
          # ====================================
          # PRODUCTION .env (Public configs only)
          # ====================================
          # NOTE: Firebase secrets are passed via --dart-define below
          # This file will be included in the public web bundle

          # TTS Service Configuration (safe to be public)
          TTS_ENDPOINT=https://tts.nairdah.me
          TTS_TIMEOUT_SECONDS=60
          TTS_MAX_RETRIES=2
          TTS_MAX_TEXT_LENGTH=5000
          TTS_AVAILABLE_VOICES=af_bella,af_sarah,af_nicole,af_sky,am_adam,am_michael,bf_emma,bf_isabella,bm_george,bm_lewis
          TTS_DEFAULT_VOICE=af_bella

          # App Configuration
          APP_NAME=Sonant Reader
          APP_VERSION=1.0.0
          APP_BUILD_NUMBER=1
          APP_ENV=production

          # Feature Flags
          ENABLE_DEBUG_LOGS=false
          ENABLE_ANALYTICS=true
          ENABLE_CRASH_REPORTING=true

          # Audio settings
          DEFAULT_VOLUME=1.0
          DEFAULT_PLAYBACK_SPEED=1.0
          PRELOAD_PAGES_COUNT=2

          # Cache settings
          MAX_AUDIO_CACHE_SIZE=50
          AUTO_SAVE_PROGRESS_INTERVAL_SECONDS=10
          EOF

      - name: ğŸ—ï¸ Build Flutter Web
        run: |
          flutter build web --release \
            --dart-define=PROJECT_ID=${{ secrets.PROJECT_ID }} \
            --dart-define=MESSAGING_SENDER_ID=${{ secrets.MESSAGING_SENDER_ID }} \
            --dart-define=STORAGE_BUCKET=${{ secrets.STORAGE_BUCKET }} \
            --dart-define=WEB_API_KEY=${{ secrets.WEB_API_KEY }} \
            --dart-define=WEB_APP_ID=${{ secrets.WEB_APP_ID }} \
            --dart-define=WEB_AUTH_DOMAIN=${{ secrets.WEB_AUTH_DOMAIN }} \
            --dart-define=WEB_MEASUREMENT_ID=${{ secrets.WEB_MEASUREMENT_ID }}

      # ===== FIREBASE DEPLOY =====
      - name: ğŸ”§ Setup Firebase CLI
        run: npm install -g firebase-tools

      - name: ğŸš€ Deploy to Firebase
        run: |
          firebase deploy \
            --only hosting \
            --project ${{ secrets.FIREBASE_PROJECT_ID }} \
            --token ${{ secrets.FIREBASE_TOKEN }} \
            --non-interactive

      - name: âœ… Deployment complete
        run: |
          echo "ğŸ‰ Deployment successful!"
          echo ""
          echo "ğŸ”— Your app is live at:"
          echo "   https://sonant.nairdah.me"  # âœ… Domeniul tÄƒu custom
          echo "   https://sonant-c81f1.web.app"
          echo ""